lowdefy: 3.23.2
name: Lowdefy starter
app:
  html:
    appendHead: |
      <script type="module" src="/public/crypto.js"></script>
connections:
  - id: mailer
    type: SendGridMail
    properties:
      apiKey:
        _secret: SENDGRID_API_KEY
      from:
        _secret: SENDGRID_FROM_ADDRESS
  - id: postgres
    type: Knex
    properties:
      client: postgres
      connection:
        _secret: PG_CONNECTION_STRING
pages:
  - id: welcome
    type: PageHeaderMenu
    properties:
      title: Welcome
    areas:
      content:
        justify: center
        blocks:
          - id: content_card
            type: Card
            style:
              maxWidth: 800
            blocks:
              - id: content
                type: Result
                properties:
                  title: Welcome to your Lowdefy app
                  subTitle: We are excited to see what you are going to build
                  icon:
                    name: HeartTwoTone
                    color: '#f00'
                areas:
                  extra:
                    blocks:
                      - id: docs_button
                        type: Button
                        properties:
                          size: large
                          title: Let's build something
                          color: '#1890ff'
                        events:
                          onClick:
                            - id: link_to_docs
                              type: Link
                              params:
                                url: https://docs.lowdefy.com
                                newTab: true
      footer:
        blocks:
          - id: footer
            type: Paragraph
            properties:
              type: secondary
              content: |
                Made by a Lowdefy ðŸ¤–
  - id: email
    type: PageSiderMenu
    properties:
      title: Send email
    requests:
      - id: send_confirmation
        type: SendGridMailSend
        connectionId: mailer
        properties:
          to:
            _state: mailto
          subject:
            _nunjucks: Reminder for {{name}}
          text:
            _nunjucks: |
              Hi {{name}}

              here's your encrypted data.

              record: {{record_id}}
              key:    {{encryption_key}}

              Cheers
      - id: db_insert
        type: KnexRaw
        connectionId: postgres
        properties:
          query: insert into confirmation (id, data) values (?, ?)
          parameters:
            - _state: record_id
            - _state: ciphertext
    areas:
      content:
        blocks:
          - id: name
            type: TextInput
            properties:
              label:
                inline: true
              title: Your name
          - id: mailto
            type: TextInput
            required: true
            validate:
              - message: Invalid email address.
                status: error
                pass:
                  _regex:
                    pattern: ^[a-z0-9~!$%\-_=+:.?\x80-\xff]+@([a-z0-9]+(--?[a-z0-9]+)*\.)+[a-z0-9]+$
                    flags: i
            properties:
              label:
                inline: true
              title: Your email address
          - id: block_id
            type: Button
            properties:
              icon: SendOutlined
              title: Send reminder
            events:
              onClick:
                - id: validate_all
                  type: Validate
                - id: extract_mailbox_name
                  type: SetState
                  params:
                    mailbox_name:
                      _string.replace:
                        on:
                          _state: mailto
                        regex: "@.+"
                        newSubstr: ""
                - id: create_aes_gcm_key
                  type: JsAction
                  params:
                    name: aesGcmCreateKey
                - id: encrypt_aes_gcm
                  type: JsAction
                  params:
                    name: aesGcmEncrypt
                    args:
                      - _state: mailto
                      - _actions: create_aes_gcm_key.response
                - id: set_encryption_key
                  type: SetState
                  params:
                    encryption_key:
                      _actions: create_aes_gcm_key.response
                - id: set_ciphertext
                  type: SetState
                  params:
                    ciphertext:
                      _actions: encrypt_aes_gcm.response
                - id: ensure_name
                  type: SetState
                  params:
                    name:
                      _if_none:
                        - _state: name
                        - _state: mailbox_name
                - id: set_record_id
                  type: SetState
                  params:
                    record_id:
                      _uuid.v4: null
                - id: store_data
                  type: Request
                  params: db_insert
                - id: send_confirmation
                  type: Request
                  params: send_confirmation
  - id: check
    type: PageSiderMenu
    properties:
      title: Check data
    requests:
      - id: db_select
        type: KnexRaw
        connectionId: postgres
        properties:
          query: select data from confirmation where id = ?
          parameters:
            - _state: record_id
    areas:
      content:
        blocks:
          - id: record_id
            type: TextInput
            properties:
              label:
                inline: true
              title: Your record ID
          - id: secret_key
            type: TextInput
            properties:
              label:
                inline: true
              title: Your secret key
          - id: block_id
            type: Button
            properties:
              icon: SendOutlined
              title: Check data
            events:
              onClick:
                - id: load_data
                  type: Request
                  params: db_select
#                - id: decrypt_aes_gcm
#                  type: JsAction
#                  params:
#                    name: aesGcmDecrypt
#                    args:
#                      - _action: load_data.response
#                      - _state: secret_key
                - id: set_decrypted_message
                  type: SetState
                  params:
                    message:
                      _json.stringify:
                        _actions: load_data.response
          - id: output
            type: Alert
            properties:
              message:
                - _state: message
